<meta charset='utf-8' />
<title></title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src="./radar1.js"></script>
<script src="./radar2.js"></script>
<script src="./radar3.js"></script>
<script src="./radar4.js"></script>
<script src="./radar5.js"></script>
<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.2/mapbox-gl.css' rel='stylesheet' />
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.2/mapbox-gl.js'></script>

<style>
    body { margin:0; padding:0; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
</style>

<div id='map'>
    <button onclick="startRadar()">radar</button>
</div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiZXRwaW5hcmQiLCJhIjoiY2luMHIyc2YwMGFzcXZobTRpYTBvZTFrOCJ9.GuIGZ1prg2ziFQ_bzdu5Lw';

var radar = [geojson1, geojson2, geojson3, geojson4, geojson5]

radar.forEach(radarElem => {
    insertColor(radarElem);
});

var finalGeoJ = radar[0];

console.log('version:', mapboxgl.version);

var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/dark-v9',
    center: [-67, 45.5],
    zoom: 4,
    pitch: 80
});

let layerNames = [];

map.on('load', function() {
    count = 0;

    radar.forEach(finalRadar => {

        var sourceName = 'source' + count;
        var layerName = 'layer' + count;
        layerNames.push(layerName);

        map.addSource(sourceName, {
            type: 'geojson',
            data: finalRadar
        });
        
        map.addLayer({
            id: layerName,
            source: sourceName,
            type: 'fill',
            paint: {
                'fill-color': ['get', 'color'],
                // 'fill-color': [
                //     //'interpolate',
                //     //['linear'],
                //     ['get', 'ptype'],
                //     'rain', '#F2F12D',
                //     'freezing_rain', '#CA8323',
                //     'snow', '#A25626',
                //     'sleet', '#723122'
                // ],
                'fill-opacity': .2
            },
            layout: {
                visibility: 'none',
            },
        });

        count ++;
    });
});

var currentRadar = [];
var radarCount = 0;

function loopRadar() {

    setInterval(function () {

        layerNames.forEach(function(layer, idx, array) {
            setInterval(function () {
                if (radarCount < 2) {
                    radarCount ++; 
                    currentRadar.push(layer);
                    map.setLayoutProperty(layer, 'visibility', 'visible');
                }   
                else if (radarCount === 2) {
                    map.setLayoutProperty(currentRadar[0], 'visibility', 'none');
                    currentRadar.shift();

                    currentRadar.push(layer);
                    map.setLayoutProperty(layer, 'visibility', 'visible');
                }
            }, 1000)
        })
        
        radarCount = 0;
        currentRadar = [];

    }, 2000)
}

const waitFor = (ms) => new Promise(r => setTimeout(r, ms))

async function asyncForEach(array, callback) {
    for (let index = 0; index < array.length; index++) {
        await callback(array[index], index, array)
    }
}

const start = async () => {
    await asyncForEach([1, 2, 3], async (num) => {
        await waitFor(2000)
        console.log(num)
    })
    console.log('Done')
}
start()

const startRadar = async () => {
    await asyncForEach(layerNames, async (layer) => {
        await waitFor(2000)

        if (radarCount < 2) {

            radarCount ++; 

            currentRadar.push(layer);

            map.setLayoutProperty(layer, 'visibility', 'visible');
            console.log('set ' + layer + ' visible');
        }   
        else if (radarCount === 2) {

            map.setLayoutProperty(currentRadar[0], 'visibility', 'none');
            console.log('set ' + currentRadar[0] + ' invisible');
            currentRadar.shift();

            currentRadar.push(layer);

            map.setLayoutProperty(layer, 'visibility', 'visible');
            console.log('set ' + layer + ' visible');
        }
    })
    setLayersInvisible();
    console.log('Done')
}
startRadar();

/* ERICHs CODE BELOW

var animate = function (isOn) {
    let self = this;
    if ("undefined" === typeof(isOn)) {
        this.isAnimating = !this.isAnimating;
    }else{
        this.isAnimating = isOn;
    }

    if (this.isAnimating) {
        this.state = 'animate';
        if (this.animateInterval) {
            clearInterval(this.animateInterval);
        }
        this.animateInterval = setInterval(function () {
            self.next();
        }, 200);
    } else {
        this.state = 'paused';
        if (this.animateInterval) {
            clearInterval(this.animateInterval);
        }
        this.currentIdx = 0;
    }
};
var next = function () {
    let c = this.currentIdx;
    let n = undefined;
    if (this.currentIdx === 0) {
        n = this.layers.length - 1;
    } else {
        n = c - 1;
    }
    this.currentIdx = n;
    this.layers[n].setVisible(true);
    this.layers[c].setVisible(false);

};

var stop = function () {
    if (this.isAnimating) {
        this.animate(false);
    }
};

*/

function setLayersInvisible() {
    layerNames.forEach(function(layer) {
        map.setLayoutProperty(layer, 'visibility', 'none');
    });
}

function sleep(milliseconds) {
  var start = new Date().getTime();
  for (var i = 0; i < 1e7; i++) {
    if ((new Date().getTime() - start) > milliseconds){
      break;
    }
  }
}

function insertColor(geoJ) {
    for(i=0; i <= geoJ.features.length - 1; i++)
        //console.log(geoJ.features[i].properties)
        if (geoJ.features[i].properties.ptype === "rain" && geoJ.features[i].properties.value === 10) {
            geoJ.features[i].properties.color = '#009fff';
        }
        else if (geoJ.features[i].properties.ptype === "rain" && geoJ.features[i].properties.value === 15) {
            geoJ.features[i].properties.color = '#0063ff';
        }
        else if (geoJ.features[i].properties.ptype === "rain" && geoJ.features[i].properties.value === 20) {
            geoJ.features[i].properties.color = '#0038ff';
        }
        else if (geoJ.features[i].properties.ptype === "rain" && geoJ.features[i].properties.value === 25) {
            geoJ.features[i].properties.color = '#0308fc';
        }
        else if (geoJ.features[i].properties.ptype === "freezing_rain") {
            geoJ.features[i].properties.color = 'yellow';
        }
        else if (geoJ.features[i].properties.ptype === "snow" && geoJ.features[i].properties.value === 10) {
            geoJ.features[i].properties.color = '#fcff00';
        }
        else if (geoJ.features[i].properties.ptype === "snow" && geoJ.features[i].properties.value === 15) {
            geoJ.features[i].properties.color = '#ffd700';
        }
        else if (geoJ.features[i].properties.ptype === "snow" && geoJ.features[i].properties.value === 20) {
            geoJ.features[i].properties.color = '#ffa100';
        }
        else if (geoJ.features[i].properties.ptype === "snow" && geoJ.features[i].properties.value === 25) {
            geoJ.features[i].properties.color = '#fc7800';
        }
        else if (geoJ.features[i].properties.ptype === "sleet") {
            geoJ.features[i].properties.color = 'pink';
        }
        else {
            geoJ.features[i].properties.color = 'blue';
        }
    return geoJ;
}

</script>