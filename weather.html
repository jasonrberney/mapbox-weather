<meta charset='utf-8' />
<title></title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src="./radar1.js"></script>
<script src="./radar2.js"></script>
<script src="./radar3.js"></script>
<script src="./radar4.js"></script>
<script src="./radar5.js"></script>
<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.2/mapbox-gl.css' rel='stylesheet' />
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.2/mapbox-gl.js'></script>

<style>
    body { margin:0; padding:0; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
</style>

<div id='map'>
    <button onclick="loopRadar()">radar</button>
</div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiZXRwaW5hcmQiLCJhIjoiY2luMHIyc2YwMGFzcXZobTRpYTBvZTFrOCJ9.GuIGZ1prg2ziFQ_bzdu5Lw';

var radar = [geojson1, geojson2, geojson3, geojson4, geojson5]

radar.forEach(radarElem => {
    insertColor(radarElem);
});

var finalGeoJ = radar[0];

console.log('version:', mapboxgl.version);

var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/dark-v9',
    center: [-67, 45.5],
    zoom: 4,
    pitch: 80
});

let layerNames = [];

map.on('load', function() {
    count = 0;

    radar.forEach(finalRadar => {

        var sourceName = 'source' + count;
        var layerName = 'layer' + count;
        layerNames.push(layerName);

        map.addSource(sourceName, {
            type: 'geojson',
            data: finalRadar
        });
        
        map.addLayer({
            id: layerName,
            source: sourceName,
            type: 'fill',
            paint: {
                'fill-color': ['get', 'color'],
                // 'fill-color': [
                //     //'interpolate',
                //     //['linear'],
                //     ['get', 'ptype'],
                //     'rain', '#F2F12D',
                //     'freezing_rain', '#CA8323',
                //     'snow', '#A25626',
                //     'sleet', '#723122'
                // ],
                'fill-opacity': .2
            },
            layout: {
                visibility: 'none',
            },
        });

        count ++;
    });
});

// setInterval(function () {

//     visibleLayers = [];

//     if(!visibleLayers.includes('layer1')) {
//         map.setLayoutProperty('layer1', 'visibility', 'visible');
//         visibleLayers.push('layer1');
//         console.log("added layer 1");
//         sleep(10000);
//     }
//     if(!visibleLayers.includes('layer2')) {
//         map.setLayoutProperty('layer2', 'visibility', 'visible');
//         visibleLayers.push('layer2');
//         console.log("added layer 2");
//         sleep(10000);
//         map.setLayoutProperty('layer1', 'visibility', 'none');
//         removeItem(visibleLayers, 'layer1');
//         console.log("removed layer 1");
//         sleep(10000);
//     }
//     if(!visibleLayers.includes('layer3')) {
//         map.setLayoutProperty('layer3', 'visibility', 'visible');
//         visibleLayers.push('layer3');
//         console.log("added layer 3");
//         sleep(10000);
//         map.setLayoutProperty('layer2', 'visibility', 'none');
//         removeItem(visibleLayers, 'layer2');
//         console.log("removed layer 2");
//         sleep(10000);
//     }
//     map.setLayoutProperty('layer3', 'visibility', 'none');
//     removeItem(visibleLayers, 'layer3');
//     console.log("removed layer 3");
// }, 10000);
var currentRadar = [];

function loopRadar() {
    radarCount = 0;

    setInterval(function () {
        
        setLayersInvisible();

        layerNames.forEach(function(layer, idx, array) {
            if (idx === array.length -1) {
                radarCount = 0;
                currentRadar = [];
            }
            else if (radarCount < 2) {

                radarCount ++; 
                currentRadar.push(layer);

                map.setLayoutProperty(layer, 'visibility', 'visible');

                // setTimeout(function () {
                //     map.setLayoutProperty(layer, 'visibility', 'visible');
                // }, 2000);          
            }   
            else if (radarCount === 2) {
                radarCount --;

                map.setLayoutProperty(currentRadar[0], 'visibility', 'none');

                currentRadar.shift();

                //radarCount ++; 
                currentRadar.push(layer);

                map.setLayoutProperty(layer, 'visibility', 'visible');
                //removeRadar(layer);

                // setTimeout(function () {
                //     removeRadar(layer);
                // }, 2000);
            }
        })
    }, 2000)
}

function setLayersInvisible() {
    layerNames.forEach(function(layer) {
        map.setLayoutProperty(layer, 'visibility', 'none');
    });
}

function removeRadar(layer) {
    map.setLayoutProperty(layer, 'visibility', 'none');

    currentRadar.shift();
}

function startRadar(index) {
    setTimeout(function () {
        map.setLayoutProperty('layer' + index, 'visibility', 'visible');
    }, 5000)
}

function sleep(milliseconds) {
  var start = new Date().getTime();
  for (var i = 0; i < 1e7; i++) {
    if ((new Date().getTime() - start) > milliseconds){
      break;
    }
  }
}

function removeItem(array, layerId) {
    var i = array.indexOf(layerId);
    if(i != -1) {
        array.splice(i,1);
    }
}

function insertColor(geoJ) {
    for(i=0; i <= geoJ.features.length - 1; i++)
        //console.log(geoJ.features[i].properties)
        if (geoJ.features[i].properties.ptype === "rain" && geoJ.features[i].properties.value === 10) {
            geoJ.features[i].properties.color = '#009fff';
        }
        else if (geoJ.features[i].properties.ptype === "rain" && geoJ.features[i].properties.value === 15) {
            geoJ.features[i].properties.color = '#0063ff';
        }
        else if (geoJ.features[i].properties.ptype === "rain" && geoJ.features[i].properties.value === 20) {
            geoJ.features[i].properties.color = '#0038ff';
        }
        else if (geoJ.features[i].properties.ptype === "rain" && geoJ.features[i].properties.value === 25) {
            geoJ.features[i].properties.color = '#0308fc';
        }
        else if (geoJ.features[i].properties.ptype === "freezing_rain") {
            geoJ.features[i].properties.color = 'yellow';
        }
        else if (geoJ.features[i].properties.ptype === "snow" && geoJ.features[i].properties.value === 10) {
            geoJ.features[i].properties.color = '#fcff00';
        }
        else if (geoJ.features[i].properties.ptype === "snow" && geoJ.features[i].properties.value === 15) {
            geoJ.features[i].properties.color = '#ffd700';
        }
        else if (geoJ.features[i].properties.ptype === "snow" && geoJ.features[i].properties.value === 20) {
            geoJ.features[i].properties.color = '#ffa100';
        }
        else if (geoJ.features[i].properties.ptype === "snow" && geoJ.features[i].properties.value === 25) {
            geoJ.features[i].properties.color = '#fc7800';
        }
        else if (geoJ.features[i].properties.ptype === "sleet") {
            geoJ.features[i].properties.color = 'pink';
        }
        else {
            geoJ.features[i].properties.color = 'blue';
        }
        //newJson.features[i].properties.color = 
    return geoJ;
}

</script>